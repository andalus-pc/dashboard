<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pendataan Santri</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/992/992700.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;
      --primary:#22c55e;--primary-2:#16a34a;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);}
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at 20% -10%,rgba(34,197,94,.15),transparent 60%),radial-gradient(1000px 500px at 100% 0%,rgba(59,130,246,.12),transparent 60%),var(--bg);color:var(--text)}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px 22px;border:1px solid rgba(148,163,184,.2);background:rgba(2,6,23,.6);border-radius:var(--radius);box-shadow:var(--shadow)}
    .logout{border:none;padding:10px 14px;border-radius:12px;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .card{margin-top:18px;background:rgba(17,24,39,.85);border:1px solid rgba(148,163,184,.2);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow)}
    h2{margin-top:0}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid rgba(148,163,184,.3);padding:8px;text-align:left}
    th{background:#1f2937}
    tr:nth-child(even){background:#111827}
    label{display:block;margin-top:10px}
    input,select{width:100%;padding:8px;border-radius:8px;background:#0b1220;color:white;border:1px solid rgba(148,163,184,.3)}
    .kelas-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px;margin-top:8px}
    .btn{margin-top:14px;padding:10px 14px;border:none;border-radius:10px;color:white;cursor:pointer;font-weight:600}
    .btn-green{background:linear-gradient(135deg,var(--primary),var(--primary-2))}
    .btn-blue{background:#2563eb}
    .btn-red{background:#f44336}
    .btn-gray{background:#9e9e9e}
    .timer{font-weight:bold;color:#fca311}
    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:9999}
    .popup{background:#1e293b;padding:24px;border-radius:14px;text-align:center;color:white;box-shadow:var(--shadow)}
    .popup button{margin-top:15px;padding:10px 16px;border:none;border-radius:10px;background:#ef4444;color:white;font-weight:600;cursor:pointer}
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="greet" id="titleText">üìù Pendataan Santri</div>
    <div>
      <button onclick="toggleLang()" class="logout" id="langBtn">üåê English</button>
      <button onclick="goBack()" class="logout" id="backBtn">‚Üê Dashboard</button>
    </div>
  </div>

  <div class="card">
    <h2 id="formTitle">Form Input</h2>
    <label id="lblNama">Nama Santri</label>
    <input type="text" id="nama" autocomplete="off">
    <label id="lblKelas">Kelas</label>
    <div class="kelas-grid" id="kelasGrid"></div>
    <label id="lblTanggal">Tanggal</label>
    <input type="text" id="tanggal" readonly>
    <label id="lblJenis">Jenis Pembelajaran</label>
    <select id="jenisPembelajaran" onchange="setTimer()">
      <option value="SNBT">SNBT - 1 jam</option>
      <option value="TKA">TKA - 1 jam</option>
      <option value="Info Kuliah">Info Kuliah - 30 menit</option>
      <option value="Ruangguru">Ruangguru - Bebas</option>
      <option value="Khusus">Khusus</option>
    </select>
    <div id="tujuanContainer" style="display:none;">
      <label id="lblTujuan">Tujuan (khusus)</label>
      <input type="text" id="tujuan" autocomplete="off">
    </div>
    <label id="lblPC">Nomor PC</label>
    <input type="text" id="pcNumber" autocomplete="off">
    <label id="lblTimer">Timer (Menit)</label>
    <input type="number" id="timer" min="1" max="180">
    <button class="btn btn-green" onclick="tambahEntri()" id="btnTambah">‚ûï Tambah Entri</button>
    <button class="btn btn-blue" onclick="exportExcel()" id="btnExport">üì§ Export Excel</button>
    <button class="btn btn-gray" onclick="resetForm()" id="btnReset">üîÑ Reset</button>
  </div>

  <div class="card">
    <h2 id="listTitle">Daftar Data</h2>
    <table id="tabelData">
      <thead>
        <tr>
          <th id="thNama">Nama</th>
          <th id="thKelas">Kelas</th>
          <th id="thTanggal">Tanggal</th>
          <th id="thJenis">Jenis</th>
          <th id="thPC">PC</th>
          <th id="thTimer">Timer</th>
          <th id="thAksi">Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<audio id="notificationSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
const KELAS_LIST=["7A","7B","7C","8A","8B","8C","9A","9B","10C","10D","10E","11C","11D","12B","12C"];
let isRunning={},intervals={},flashIntervalId=null,isFlashing=false,originalTitle=document.title;
let lang="id"; // default bahasa

// ===== TRANSLATIONS =====
const textMap={
  id:{
    title:"üìù Pendataan Santri", back:"‚Üê Dashboard", form:"Form Input", nama:"Nama Santri",
    kelas:"Kelas", tanggal:"Tanggal", jenis:"Jenis Pembelajaran", tujuan:"Tujuan (khusus)",
    pc:"Nomor PC", timer:"Timer (Menit)", tambah:"‚ûï Tambah Entri", export:"üì§ Export Excel",
    reset:"üîÑ Reset", list:"Daftar Data", aksi:"Aksi", popupTitle:"‚è∞ Timer Habis", popupClose:"Tutup",
    notif:"Pendataan Santri"
  },
  en:{
    title:"üìù Student Data Entry", back:"‚Üê Dashboard", form:"Input Form", nama:"Student Name",
    kelas:"Class", tanggal:"Date", jenis:"Learning Type", tujuan:"Purpose (special)",
    pc:"PC Number", timer:"Timer (Minutes)", tambah:"‚ûï Add Entry", export:"üì§ Export to Excel",
    reset:"üîÑ Reset", list:"Data List", aksi:"Action", popupTitle:"‚è∞ Time's Up", popupClose:"Close",
    notif:"Student Data Entry"
  }
};

function toggleLang(){
  lang=(lang==="id"?"en":"id");
  const t=textMap[lang];
  document.getElementById("titleText").innerText=t.title;
  document.getElementById("backBtn").innerText=t.back;
  document.getElementById("formTitle").innerText=t.form;
  document.getElementById("lblNama").innerText=t.nama;
  document.getElementById("lblKelas").innerText=t.kelas;
  document.getElementById("lblTanggal").innerText=t.tanggal;
  document.getElementById("lblJenis").innerText=t.jenis;
  document.getElementById("lblTujuan").innerText=t.tujuan;
  document.getElementById("lblPC").innerText=t.pc;
  document.getElementById("lblTimer").innerText=t.timer;
  document.getElementById("btnTambah").innerText=t.tambah;
  document.getElementById("btnExport").innerText=t.export;
  document.getElementById("btnReset").innerText=t.reset;
  document.getElementById("listTitle").innerText=t.list;
  document.getElementById("thNama").innerText=t.nama;
  document.getElementById("thKelas").innerText=t.kelas;
  document.getElementById("thTanggal").innerText=t.tanggal;
  document.getElementById("thJenis").innerText=t.jenis;
  document.getElementById("thPC").innerText=t.pc;
  document.getElementById("thTimer").innerText=t.timer;
  document.getElementById("thAksi").innerText=t.aksi;
  document.getElementById("langBtn").innerText=(lang==="id"?"üåê English":"üåê Indonesia");
}

// ====== UTILITY ======
function renderKelasOptions(){
  const grid=document.getElementById("kelasGrid");
  grid.innerHTML=KELAS_LIST.map(k=>`<label><input type="radio" name="kelas" value="${k}">${k}</label>`).join('');
}
function goBack(){window.location.href="index.html";}
document.getElementById("tanggal").value=new Date().toLocaleDateString("id-ID");

function setTimer(){
  const jenis=document.getElementById("jenisPembelajaran").value;
  const timer=document.getElementById("timer");
  const tujuan=document.getElementById("tujuanContainer");
  if(jenis==="SNBT"||jenis==="TKA"){timer.value=60;timer.disabled=true;tujuan.style.display="none";}
  else if(jenis==="Info Kuliah"){timer.value=30;timer.disabled=true;tujuan.style.display="none";}
  else if(jenis==="Khusus"){timer.value="";timer.disabled=false;tujuan.style.display="block";}
  else{timer.value="";timer.disabled=false;tujuan.style.display="none";}
}

function startFlashing(title){
  if(isFlashing)return;
  isFlashing=true;
  let showOriginal=false;
  flashIntervalId=setInterval(()=>{document.title=showOriginal?originalTitle:title;showOriginal=!showOriginal;},1000);
}
function stopFlashing(){if(isFlashing){clearInterval(flashIntervalId);document.title=originalTitle;isFlashing=false;}}

// ====== MAIN ======
function tambahEntri(){
  const nama=document.getElementById("nama").value.trim();
  const kelas=document.querySelector('input[name="kelas"]:checked')?.value||"";
  const tanggal=document.getElementById("tanggal").value;
  const jenis=document.getElementById("jenisPembelajaran").value;
  const tujuan=document.getElementById("tujuan").value.trim();
  const pc=document.getElementById("pcNumber").value.trim();
  const timer=document.getElementById("timer").value.trim();
  if(!nama||!kelas||!pc||!timer){alert("Isi semua kolom! / Fill all fields!");return;}

  const tbody=document.querySelector("#tabelData tbody");
  const row=tbody.insertRow();
  row.insertCell(0).innerText=nama;
  row.insertCell(1).innerText=kelas;
  row.insertCell(2).innerText=tanggal;
  row.insertCell(3).innerText=(jenis==="Khusus"?jenis+" - "+tujuan:jenis);
  row.insertCell(4).innerText=pc;
  row.insertCell(5).innerText=timer+" menit";
  const act=row.insertCell(6);
  act.innerHTML=`<button class="btn btn-blue" onclick="startStopTimer(this,${tbody.rows.length-1},${timer})">Start</button>
                 <button class="btn btn-red" onclick="deleteRow(this)">Delete</button>`;

  resetFields();
  const startBtn=act.querySelector(".btn-blue");
  startStopTimer(startBtn,tbody.rows.length-1,timer);
}

function parseTime(t){if(t.includes(":")){const [m,s]=t.split(":");return parseInt(m)*60+(parseInt(s)||0);}return parseInt(t)*60;}

function startStopTimer(btn,rowIndex,timer){
  const row=document.querySelector("#tabelData tbody").rows[rowIndex];
  const cell=row.cells[5];
  let left=parseTime(cell.innerText.includes(":")?cell.innerText:timer);
  if(!isRunning[rowIndex]){
    intervals[rowIndex]=setInterval(()=>{
      if(left<=0){
        clearInterval(intervals[rowIndex]);
        cell.innerText="Selesai!";
        playSound();
        const nama=row.cells[0].innerText,pc=row.cells[4].innerText;
        startFlashing(`‚è∞ ${nama} PC ${pc} selesai`);
        showPopup(`${nama} - PC ${pc}`);
        showNotif(`${nama} - PC ${pc}`);
        btn.innerText="Start";isRunning[rowIndex]=false;
      }else{
        const m=Math.floor(left/60),s=left%60;
        cell.innerText=`${m}:${s<10?"0":""}${s}`;
        left--;
      }
    },1000);
    btn.innerText="Stop";isRunning[rowIndex]=true;
  }else{clearInterval(intervals[rowIndex]);btn.innerText="Start";isRunning[rowIndex]=false;}
}

function deleteRow(btn){btn.parentElement.parentElement.remove();}

function playSound(){const a=document.getElementById("notificationSound");a.loop=true;a.currentTime=0;a.play();}
function stopSound(){const a=document.getElementById("notificationSound");a.pause();a.currentTime=0;a.loop=false;}

function showPopup(msg){
  const t=textMap[lang];
  const overlay=document.createElement("div");overlay.className="popup-overlay";
  const pop=document.createElement("div");pop.className="popup";
  pop.innerHTML=`<h2>${t.popupTitle}</h2><p>${msg}</p><button onclick="closePopup()">${t.popupClose}</button>`;
  overlay.appendChild(pop);document.body.appendChild(overlay);
}
function closePopup(){document.querySelector(".popup-overlay").remove();stopSound();stopFlashing();}

function showNotif(txt){
  const t=textMap[lang];
  if("Notification"in window&&Notification.permission==="granted"){
    new Notification(t.notif,{body:txt,icon:"https://cdn-icons-png.flaticon.com/512/992/992700.png"});
  }
}

function exportExcel(){
  const tbl=document.getElementById("tabelData");
  const wb=XLSX.utils.table_to_book(tbl,{sheet:"Santri"});
  XLSX.writeFile(wb,"pendataan_"+new Date().toISOString().slice(0,10)+".xlsx");
}
function resetForm(){
  if(confirm("Sudah export data ke Excel? / Already exported data?")){
    document.querySelector("#tabelData tbody").innerHTML="";
    resetFields();
  }
}
function resetFields(){
  document.getElementById("nama").value="";
  document.querySelectorAll('input[name="kelas"]').forEach(c=>c.checked=false);
  document.getElementById("pcNumber").value="";
  document.getElementById("timer").value="";
  document.getElementById("tujuan").value="";
  document.getElementById("jenisPembelajaran").value="SNBT";
  setTimer();
}

if("Notification"in window&&Notification.permission==="default"){Notification.requestPermission();}
renderKelasOptions();setTimer();
</script>
</body>
</html>

